<!-- app/templates/camera.html -->
{% extends "base.html" %}

{% block title %}Kamera - Unkraut-2025{% endblock %}
{% block page_title %}ğŸ“· Kamera & Unkraut-Erkennung (DEBUG){% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/camera.css') }}">
<style>
    /* Debug-Indicator */
    .debug-indicator {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(255, 0, 0, 0.8);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        z-index: 9999;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 0.8; }
        50% { opacity: 1; }
    }
    
    /* Touch-Visual-Feedback verstÃ¤rken */
    .btn:active, .btn.touched {
        transform: scale(0.9) !important;
        background: rgba(255, 255, 255, 0.3) !important;
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.5) !important;
    }
    
    /* Foto-Button besonders hervorheben */
    .capture-btn {
        border: 3px solid #28a745 !important;
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.5) !important;
        font-size: 18px !important;
        font-weight: bold !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- DEBUG INDICATOR -->
<div class="debug-indicator" id="debug-indicator">
    ğŸ” DEBUG AKTIV - Terminal Logging
</div>

<!-- Kamera Stream -->
<div class="camera-section">
    <div class="card">
        <h3>ğŸ“¹ Live Kamera-Stream (DEBUG)</h3>
        <div class="stream-container">
            <img id="camera-stream" 
                 src="/api/camera/stream" 
                 alt="Kamera Stream" 
                 class="camera-stream">
        </div>
        
        <div class="camera-controls">
            <button id="capture-btn" class="btn btn-primary capture-btn" onclick="debugCaptureImage()">
                ğŸ“¸ Foto aufnehmen (DEBUG)
            </button>
            <button class="btn btn-secondary" onclick="debugToggleStream()">
                ğŸ”„ Stream toggle
            </button>
        </div>
        
        <div class="camera-stats">
            <div class="stat-item">
                <span class="stat-label">CPU:</span>
                <span id="cpu-usage" class="stat-value">0%</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">RAM:</span>
                <span id="ram-usage" class="stat-value">0%</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Temp:</span>
                <span id="cpu-temp" class="stat-value">0Â°C</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Kamera:</span>
                <span id="camera-status" class="stat-value">Offline</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Roboterarm:</span>
                <span id="arm-status" class="stat-value">Mock</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">FPS:</span>
                <span id="stream-fps" class="stat-value">0 FPS</span>
            </div>
        </div>
    </div>
</div>

<!-- Unkraut-Erkennung -->
<div class="detection-section">
    <div class="card">
        <h3>ğŸŒ¿ Unkraut-Erkennung</h3>
        
        <div class="detection-controls">
            <button class="btn btn-success" onclick="debugDetectWeeds()">
                ğŸ” Unkraut erkennen
            </button>
            <button class="btn btn-info" onclick="debugContinuousDetection()">
                ğŸ“¹ Kontinuierliche Erkennung
            </button>
        </div>
        
        <div class="detection-results">
            <h4>Erkennungsergebnisse:</h4>
            <div id="detection-results" class="results-display">
                Keine Erkennungen
            </div>
        </div>
        
        <button class="btn btn-secondary" onclick="debugClearResults()">
            ğŸ—‘ï¸ Ergebnisse lÃ¶schen
        </button>
    </div>
</div>

<!-- Bildergalerie -->
<div class="gallery-section">
    <div class="gallery-header">
        <h3>ğŸ“ Aufgenommene Bilder</h3>
        <div class="gallery-stats">
            <span id="gallery-count">0 Bilder</span>
            <span id="gallery-size">0 MB</span>
        </div>
    </div>
    
    <div id="image-gallery" class="image-gallery">
        <div class="no-images">
            Keine Bilder aufgenommen
        </div>
    </div>
    
    <div class="gallery-controls">
        <button class="btn btn-info" onclick="debugLoadImageGallery()">
            ğŸ”„ Galerie laden
        </button>
        <button class="btn btn-warning" onclick="debugDownloadImages()">
            ğŸ’¾ Bilder herunterladen
        </button>
        <button class="btn btn-danger" onclick="debugClearImages()">
            ğŸ—‘ï¸ Alle lÃ¶schen
        </button>
    </div>
</div>

<!-- Debug-Info Panel (nur fÃ¼r Debug) -->
<div class="card" style="margin-top: 20px; background: rgba(255, 0, 0, 0.1); border: 2px solid red;">
    <h3>ğŸ” Debug-Informationen</h3>
    <div id="debug-info" style="font-family: monospace; font-size: 12px; color: #ccc;">
        Debug-Logs werden auf Python-Terminal ausgegeben...
    </div>
    <div style="margin-top: 10px;">
        <button class="btn btn-warning" onclick="testAllFunctions()">
            ğŸ§ª Alle Funktionen testen
        </button>
        <button class="btn btn-info" onclick="logSystemInfo()">
            ğŸ“Š System-Info loggen
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Debug-Logging als erstes laden -->
<script src="{{ url_for('static', filename='js/debug_logging.js') }}"></script>

<!-- Dann Kamera-JavaScript -->
<script src="{{ url_for('static', filename='js/camera.js') }}"></script>

<!-- Debug-Wrapper Funktionen -->
<script>
// Debug-Wrapper fÃ¼r alle Kamera-Funktionen
function debugCaptureImage() {
    debugLog('ğŸ“¸ DEBUG: captureImage() Wrapper aufgerufen', 'CAMERA', 'DEBUG');
    
    // Visuelles Feedback
    const btn = document.getElementById('capture-btn');
    if (btn) {
        btn.classList.add('touched');
        setTimeout(() => btn.classList.remove('touched'), 200);
    }
    
    // Original-Funktion aufrufen
    if (typeof captureImage === 'function') {
        captureImage();
    } else {
        debugLog('âŒ captureImage Funktion nicht gefunden!', 'ERROR', 'DEBUG');
    }
}

function debugToggleStream() {
    debugLog('ğŸ”„ DEBUG: toggleStream() aufgerufen', 'INFO', 'DEBUG');
    if (typeof toggleStream === 'function') {
        toggleStream();
    }
}

function debugDetectWeeds() {
    debugLog('ğŸŒ¿ DEBUG: detectWeeds() aufgerufen', 'INFO', 'DEBUG');
    if (typeof detectWeeds === 'function') {
        detectWeeds();
    }
}

function debugContinuousDetection() {
    debugLog('ğŸ“¹ DEBUG: continuousDetection() aufgerufen', 'INFO', 'DEBUG');
    if (typeof continuousDetection === 'function') {
        continuousDetection();
    }
}

function debugClearResults() {
    debugLog('ğŸ—‘ï¸ DEBUG: clearResults() aufgerufen', 'INFO', 'DEBUG');
    if (typeof clearResults === 'function') {
        clearResults();
    }
}

function debugLoadImageGallery() {
    debugLog('ğŸ”„ DEBUG: loadImageGallery() aufgerufen', 'INFO', 'DEBUG');
    if (typeof loadImageGallery === 'function') {
        loadImageGallery();
    }
}

function debugDownloadImages() {
    debugLog('ğŸ’¾ DEBUG: downloadImages() aufgerufen', 'INFO', 'DEBUG');
    if (typeof downloadImages === 'function') {
        downloadImages();
    }
}

function debugClearImages() {
    debugLog('ğŸ—‘ï¸ DEBUG: clearImages() aufgerufen', 'INFO', 'DEBUG');
    if (typeof clearImages === 'function') {
        clearImages();
    }
}

// Test-Funktionen
function testAllFunctions() {
    debugLog('ğŸ§ª Teste alle Funktionen...', 'INFO', 'TEST');
    
    const functions = [
        'captureImage', 'toggleStream', 'detectWeeds', 
        'continuousDetection', 'clearResults', 'loadImageGallery',
        'downloadImages', 'clearImages', 'updateCameraStats'
    ];
    
    functions.forEach(funcName => {
        if (typeof window[funcName] === 'function') {
            debugLog(`âœ… ${funcName}: verfÃ¼gbar`, 'SUCCESS', 'TEST');
        } else {
            debugLog(`âŒ ${funcName}: NICHT VERFÃœGBAR`, 'ERROR', 'TEST');
        }
    });
    
    // Touch-Test
    const hasTouch = 'ontouchstart' in window;
    const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    debugLog(`ğŸ“± Touch Support: ${hasTouch}`, hasTouch ? 'SUCCESS' : 'ERROR', 'TEST');
    debugLog(`ğŸ“± Mobile Device: ${isMobile}`, isMobile ? 'SUCCESS' : 'INFO', 'TEST');
}

function logSystemInfo() {
    debugLog('ğŸ“Š System-Info wird geloggt...', 'INFO', 'SYSTEM');
    
    const info = {
        userAgent: navigator.userAgent,
        viewport: `${window.innerWidth}x${window.innerHeight}`,
        screen: `${screen.width}x${screen.height}`,
        pixelRatio: window.devicePixelRatio,
        touchPoints: navigator.maxTouchPoints,
        language: navigator.language,
        platform: navigator.platform,
        cookieEnabled: navigator.cookieEnabled,
        onLine: navigator.onLine
    };
    
    debugLog('ğŸ“Š Browser-Info:', 'INFO', 'SYSTEM', info);
}

// Auto-Update fÃ¼r Debug-Info
setInterval(() => {
    const debugDiv = document.getElementById('debug-info');
    if (debugDiv) {
        const now = new Date();
        debugDiv.innerHTML = `
            Debug aktiv seit: ${now.toLocaleTimeString()}<br>
            Logs werden auf Python-Terminal ausgegeben<br>
            Touch Events: ${'ontouchstart' in window ? 'Aktiv' : 'Nicht verfÃ¼gbar'}<br>
            Mobile Device: ${/Mobile/i.test(navigator.userAgent) ? 'Ja' : 'Nein'}<br>
            Viewport: ${window.innerWidth}x${window.innerHeight}
        `;
    }
}, 1000);

// Debug-Ready Signal
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        debugLog('ğŸ¯ DEBUG-VERSION bereit - alle Logs gehen an Terminal!', 'SUCCESS', 'READY');
        testAllFunctions();
        logSystemInfo();
    }, 2000);
});
</script>
{% endblock %}